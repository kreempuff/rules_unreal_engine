"""BLAKE3 cryptographic hash function.

Fast cryptographic hashing based on Bao and BLAKE2.
We build from source instead of using Epic's prebuilt libraries for hermetic builds.

Converted from: Engine/Source/ThirdParty/BLAKE3/BLAKE3.Build.cs
"""

load("@rules_cc//cc:defs.bzl", "cc_library")

# BLAKE3 has platform-specific SIMD implementations
# Using cc_library directly because ue_module can't handle select() in srcs
cc_library(
    name = "BLAKE3",

    # C source files (will be compiled with C compiler)
    # Platform-specific SIMD: x86-64 gets SSE/AVX, ARM gets NEON
    srcs = [
        # Common files (all platforms)
        "1.3.1/c/blake3.c",
        "1.3.1/c/blake3_dispatch.c",
        "1.3.1/c/blake3_portable.c",
    ] + select({
        # x86-64 platforms (Mac Intel, Linux x86, Windows x86)
        "@platforms//cpu:x86_64": [
            "1.3.1/c/blake3_sse2.c",
            "1.3.1/c/blake3_sse41.c",
            "1.3.1/c/blake3_avx2.c",
            "1.3.1/c/blake3_avx512.c",
        ],
        # ARM64 platforms (Mac M1/M2, Linux ARM, iOS, Android ARM)
        "@platforms//cpu:arm64": [
            "1.3.1/c/blake3_neon.c",
        ],
        "@platforms//cpu:aarch64": [
            "1.3.1/c/blake3_neon.c",
        ],
        # Fallback: portable only (no SIMD)
        "//conditions:default": [],
    }),

    hdrs = [
        "1.3.1/c/blake3.h",
        "1.3.1/c/blake3_impl.h",
    ],

    # From BLAKE3.Build.cs: PublicSystemIncludePaths
    includes = ["1.3.1/c"],

    # C-specific compiler flags
    copts = ["-std=c11", "-Wall"],

    visibility = ["//visibility:public"],
    tags = ["third_party", "blake3"],
)
